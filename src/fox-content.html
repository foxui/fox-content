<fox-element name="fox-refresher">
    <fox-template>
        <div id="fox-refresher-content" class="fox-refresher-content">
            <content></content>
        </div>
    </fox-template>
    <script>
        
        fox("fox-refresher",{
            lifecycle:{
                created:function(){
                    
                },
                inserted:function(){
                    var pulltorefreshHeight = $(this).height();
                    $(this).css({
                        top : -pulltorefreshHeight + "px"
                    });
                }
            },
            methods:{
                refreshComplete:function(){
                    $(this).closest("fox-content").get(0)._refreshComplete();
                },
                fireRefresh:function(){
                    xtag.fireEvent(this, 'refresh', {});
                }
                
            }
        });
        
    </script>

</fox-element>

<fox-element name="fox-infinite-scroll" attributes="distance">
    <script>
        fox("fox-infinite-scroll",{
            lifecycle:{
                created:function(){
                    this.distance = this.distance || 0;
                    this.enable = true;   
                }
            },
            methods:{
                getDistance:function(height){
                    var distance = this.distance;
                    
                    var pattrn = /(\d+)(%?)/.exec(distance);
                    if (!pattrn || pattrn[2]=="") {
                        return height-(parseInt(distance)||0);
                    }
                    if (pattrn[2] != "") {
                        return height-(height * pattrn[1] / 100);
                    }
                },
                fireInfinite:function(){
                    if(this.enable){
                        this.enable = false;
                        xtag.fireEvent(this, 'infinite', {});    
                    }
                    
                },
                infiniteComplete:function(){
                    this.enable = true;
                }
            }
        });
    </script>
</fox-element>

<fox-element name="fox-content" >
    <fox-template>
        <div id="fox-content-scroller" class="fox-content-scroller">
            <content></content>
        </div>

    </fox-template>
    <script>
		function setupPulltorefresh($pulltorefresh) {

			function translateDom(dist, speed) {
			    var height = dist-$(self).scrollTop();
			    var className = Math.min(parseInt((height / pulltorefreshHeight)), 1) === 0 ? "up":"down";
				$pulltorefresh.get(0).className = "fox-refresher-status-" + className;
                
				scroller.style.webkitTransitionDuration = scroller.style.MozTransitionDuration = scroller.style.msTransitionDuration = scroller.style.OTransitionDuration = scroller.style.transitionDuration = speed + 'ms';
				scroller.style.webkitTransform = 'translate3d(0,' + dist + 'px,0)';
				scroller.style.msTransform = scroller.style.MozTransform = scroller.style.OTransform = 'translateY(' + dist + 'px)';
			}

			var $content = $(this.$['fox-listview-content']);
			var $refresherContent = $(this.$['fox-refresher-content']);
			var pulltorefreshHeight = $pulltorefresh.height();
			var self = this;
			var scroller = this.$['fox-content-scroller'];
			scroller.addEventListener('webkitTransitionEnd', function() {
				setTimeout(function() {
					$content.height($content.height() + 1);
				}, 50);

			}, false);
			var startY, startTop;
			var translateY = 0, endTranslateY = 0;
			this.addEventListener("touchstart", function(e) {
				startY = e.touches[0].pageY;
				startTop = $(this).scrollTop();

			}, true);
			this.addEventListener("touchmove", function(e) {
				var deltaY = (e.touches[0].pageY - startY) * 0.35;
                
				if(!isRefreshing){
				    if ($(this).scrollTop() <= 0) {
                        if (deltaY > 0 && endTranslateY == 0) {
                            translateY = $(this).scrollTop() + deltaY;
                            translateDom($(this).scrollTop() + deltaY, 0);
                            e.preventDefault();
                        }
    
                    } else {
                        startY = e.touches[0].pageY;
                    }
				}
				

			}, true);
            
            var isRefreshing = false;
            
			this.addEventListener("touchend", function(e) {
			    if(!isRefreshing){
			        if (translateY-$(self).scrollTop() >= pulltorefreshHeight ) {
                        translateY = pulltorefreshHeight;
                        endTranslateY = translateY;
                        translateDom(pulltorefreshHeight, 200);
                        $pulltorefresh.get(0).fireRefresh();
                        isRefreshing = true;
                        $pulltorefresh.get(0).className = "fox-refresher-status-loading";
                    } else {
                        ret.refreshComplete();
                    }
			    }
				

			}, true);

			var ret = {
				refreshComplete : function() {
				    isRefreshing = false;
					$pulltorefresh.get(0).className = "fox-refresher-status-up";
					translateDom(0, 200);
					translateY = 0;
					endTranslateY = 0;
				}
			}

			return ret;

		}
		
		function setupInfiniteScroll($infiniteScroll){
		    var infiniteScroll = $infiniteScroll.get(0);
		    $(this).bind("scroll",function(){
		        if(this.scrollTop+$(this).height()>= infiniteScroll.getDistance(this.scrollHeight)){
		            infiniteScroll.fireInfinite();
		        }
		       
		    });
		}

		var pulltorefresh;

		fox("fox-content", {
			lifecycle : {
				created : function() {
				    var $pulltorefresh = $("fox-refresher",this);
				    if($pulltorefresh.size()>0){
				        pulltorefresh = setupPulltorefresh.call(this,$pulltorefresh);
				    }
				    var $infiniteScroll = $("fox-infinite-scroll",this);
				    
				    if($infiniteScroll.size()>0){
				        setupInfiniteScroll.call(this,$infiniteScroll);
				    }
				    
				},
				inserted : function() {

				}
			},
			methods : {
				_refreshComplete : function() {

					pulltorefresh && pulltorefresh.refreshComplete();
				}
			}
		});
    </script>

</fox-element>
