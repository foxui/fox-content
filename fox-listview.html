<fox-element name="fox-listview" >
    <fox-template>
        <div id="fox-listview-scroller">
            <div id="fox-listview-pulltorefresh" class="fox-listview-pulltorefresh">
                <div id="pulltorefresh-inner">
                    <i class="icon-indicator icon-up-1"></i>
                    <i class="icon-spin5 icon-loading animate-spin"></i>
                    <label></label>
                </div>
            </div>
            <div id="fox-listview-content" class="fox-listview-content" >
                <content></content>
            </div>
        </div>

    </fox-template>
    <script>
		function setupPulltorefresh() {

			function translateDom(dist, speed) {
				pulltorefreshInner.className = "pulltorefresh-state-" + Math.min(parseInt((dist / pulltorefreshHeight)), 1);
				
				scroller.style.webkitTransitionDuration = scroller.style.MozTransitionDuration = scroller.style.msTransitionDuration = scroller.style.OTransitionDuration = scroller.style.transitionDuration = speed + 'ms';
				scroller.style.webkitTransform = 'translate3d(0,' + dist + 'px,0)';
				scroller.style.msTransform = scroller.style.MozTransform = scroller.style.OTransform = 'translateY(' + dist + 'px)';
			}

			var $listviewContent = $(this.$['fox-listview-content']);
			var $pulltorefresh = $(this.$['fox-listview-pulltorefresh']);
			var pulltorefreshInner = this.$['pulltorefresh-inner'];
			var pulltorefreshHeight = $pulltorefresh.height();
			$(this.$['fox-listview-pulltorefresh']).css({
				top : -pulltorefreshHeight + "px"
			});
			var scroller = this.$['fox-listview-scroller'];
			scroller.addEventListener('webkitTransitionEnd', function() {
				setTimeout(function() {
					$listviewContent.height($listviewContent.height() + 1);
				}, 50);

			}, false);
			var startY, startTop;
			var translateY = 0, endTranslateY = 0;
			this.addEventListener("touchstart", function(e) {
				startY = e.touches[0].pageY;
				startTop = $(this).scrollTop();

			}, true);
			this.addEventListener("touchmove", function(e) {
				var deltaY = (e.touches[0].pageY - startY) * 0.35;
				
				if(deltaY<0 && this.scrollTop+$(this).height()==this.scrollHeight){
				    startY = e.touches[0].pageY;
				    e.preventDefault();
				    
				    return;
				}
				console.info(deltaY);
				if ($(this).scrollTop() <= 0) {
                    
					if (deltaY > 0 && endTranslateY == 0) {
						translateY = $(this).scrollTop()+deltaY;
						translateDom(deltaY, 0);
						e.preventDefault();
					}else{
					   startY = e.touches[0].pageY; 
					}

				} 

			}, true);

			this.addEventListener("touchend", function(e) {
				if (translateY>= pulltorefreshHeight) {
					translateY = pulltorefreshHeight;
					endTranslateY = translateY;
					translateDom(pulltorefreshHeight, 200);
					onRefresh && onRefresh.call(this);
					pulltorefreshInner.className = "pulltorefresh-state-loading";
				} else {
					ret.refreshComplete();
				}

			}, true);

			var onRefresh;

			var ret = {
				refreshComplete : function() {
					pulltorefreshInner.className = "pulltorefresh-state";
					translateDom(0, 200);

					translateY = 0;
					endTranslateY = 0;
				},
				onRefresh : function(callback) {

					onRefresh = callback;
				}
			}

			return ret;

		}

		var pulltorefresh;

		fox("fox-listview", {
			lifecycle : {
				created : function() {
                    pulltorefresh = setupPulltorefresh.apply(this);
				},
				inserted : function() {
					
				}
			},
			methods : {
				refreshComplete : function() {

					pulltorefresh.refreshComplete();
				},
				onRefresh : function(callback) {
                    
					pulltorefresh.onRefresh(callback);
				}
			}
		});
    </script>

</fox-element>
